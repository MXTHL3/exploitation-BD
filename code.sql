create table PROPRIO (
    IdP number(10),
    Nom varchar2(15),
    Prenom varchar2(15),
    constraint pk_IdP primary key(IdP));    
    
create table BIEN (
    IdEBien number(10),
    Categorie varchar2(15),
    Type_ varchar2(6),
    IdP number(10),
    Ville varchar2(45),
    Prix number(7),
    constraint pk_IdEBien primary key(IdEBien),
    constraint fk_IdP foreign key (IdP) references PROPRIO(IdP));
    
create table ESPACE (
    IdE number(10),
    Designation varchar2(50),
    Superficie number(3),
    IdERattach number(4),
    constraint pk_IdE primary key(IdE),
    constraint fk_IdERattach foreign key(IdERattach) references BIEN(IdEBien));


insert into PROPRIO values(25,'Guédès','Alexandre');
insert into PROPRIO values(29,'Jaidoux','Alexis');
insert into PROPRIO values(35,'de Boute','Maël');
insert into PROPRIO values(53,'Séjourné','Mathis');
insert into PROPRIO values(61,'Gouache','Victor');

insert into BIEN values(110,'Appartement','T4',25,'Marseille',80000);
insert into BIEN values(117,'Appartement','Studio',29,'Marseille',90000);
insert into BIEN values(171,'Appartement','T1',35,'Paris',250000);
insert into BIEN values(192,'Appartement','T1',35,'Paris',340000);
insert into BIEN values(945,'Maison de ville','T8',53,'Nice',280000);
insert into BIEN values(227,'Appartement','T3',61,'Nice',130000);
insert into BIEN values(238,'Villa','T7',61,'Nice',170000);

insert into ESPACE values(1101,'Salon',15,110);
insert into ESPACE values(1104,'Cuisine',7,110);
insert into ESPACE values(1102,'Salle de bain',5,110);
insert into ESPACE values(1103,'Chambre',8,110);
insert into ESPACE values(1171,'Pièce à vivre',30,117);
insert into ESPACE values(1711,'Pièce à vivre',12,171);
insert into ESPACE values(1921,'Pièce à vivre',15,192);
insert into ESPACE values(9451,'Salon',20,945);
insert into ESPACE values(9454,'Cuisine',8,945);
insert into ESPACE values(9453,'Chambre',30,945);
insert into ESPACE values(9452,'Salle de bain',6,945);
insert into ESPACE values(2271,'Salon',10,227);
insert into ESPACE values(2273,'Chambre',20,227);
insert into ESPACE values(2272,'Salle de bain',5,227);
insert into ESPACE values(2381,'Salon',15,238);
insert into ESPACE values(2384,'Cuisine',10,238);
insert into ESPACE values(2382,'Salle de bain',10,238);
insert into ESPACE values(2383,'Chambres',25,238);

select *
from ESPACE;

select count(distinct Categorie) and count(distinct Type_)
from BIEN;

select IdE,Designation
from ESPACE
join BIEN
on ESPACE.IdERattach=BIEN.IdEBien
where IdERattach=945;

select IdP,Nom,Prenom
from PROPRIO;

drop table ESPACE;
drop table BIEN;
drop table PROPRIO;


--q1

select count(*) Categorie, Type_  
from BIEN
group by Categorie, Type_;

--q2

WITH RECURSIVE Sous_espaces AS (
  SELECT IdE, Designation
  FROM ESPACE
  WHERE IdERattach = 945
  UNION
  SELECT e.IdE, e.Designation
  FROM ESPACE e
  JOIN Sous_espaces se ON e.IdERattach = se.IdE
)
SELECT IdE, Designation
FROM Sous_espaces;

--q3

-- Avec un opérateur ensembliste
SELECT IdP, Nom, Prenom
FROM PROPRIO
WHERE IdP NOT IN (
  SELECT DISTINCT IdP
  FROM BIEN
  WHERE Ville = 'Marseille'
);

-- Avec une jointure externe
SELECT p.IdP, p.Nom, p.Prenom
FROM PROPRIO p
LEFT JOIN BIEN b ON p.IdP = b.IdP AND b.Ville = 'Marseille'
WHERE b.IdP IS NULL;

--q4

 SELECT Ville 
FROM BIEN 
WHERE Categorie = 'Maison de ville' 
GROUP BY Ville 
HAVING COUNT(*) > 10; 

--q5

SELECT IdEBien, Prix - MIN(Prix) OVER () AS Prix_Ecart_Min 
FROM BIEN;

--q6

SELECT IdEBien, Prix - MIN(Prix) OVER (PARTITION BY Categorie) AS Prix_Ecart_Min_Categ 
FROM BIEN;

--q7

SELECT IdP, COUNT() AS NbBiens 
FROM BIEN 
WHERE Type = 'Studio' 
GROUP BY IdP 
HAVING COUNT() >= 2;

--q8

SELECT IdP, COUNT(DISTINCT Categorie) AS Nb_Categ 
FROM PROPRIO 
JOIN BIEN ON PROPRIO.IdP = BIEN.IdP 
GROUP BY IdP 
HAVING COUNT(DISTINCT Categorie) = (SELECT COUNT(DISTINCT Categorie) FROM BIEN);

--q9

SELECT IdEBien 
FROM ESPACE 
WHERE Designation = 'Terrasse' 
ORDER BY Superficie DESC 
FETCH FIRST 1 ROWS ONLY;

--q10

SELECT DISTINCT IdP 
FROM BIEN 
WHERE Categorie IN 
  (SELECT DISTINCT Categorie FROM BIEN WHERE IdP = 105) 
AND IdP != 105;
